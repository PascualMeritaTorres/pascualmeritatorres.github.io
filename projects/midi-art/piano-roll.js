class PianoRoll{constructor(t={}){this.keyboard=document.getElementById("piano-keyboard"),this.gridWrapper=document.getElementById("piano-grid-wrapper"),this.canvas=document.getElementById("piano-grid"),this.notesContainer=document.getElementById("notes-container"),this.playhead=document.getElementById("playhead"),this.playheadHandle=document.getElementById("playhead-handle"),this.timeline=document.getElementById("timeline"),this.ctx=this.canvas.getContext("2d"),this.totalKeys=88,this.lowestNote=21,this.highestNote=108,this.basePitch=60,this.updateDimensions(),this.notes=[],this.zoom=1,this.minZoom=.5,this.maxZoom=3,this.totalColumns=100,this.isDirty=!1,this.selectedNote=null,this.dragState=null,this.longPressTimer=null,this.longPressDelay=500,this.lastNoteDuration=4,this.onNotePreview=t.onNotePreview||(()=>{}),this.onNotesChange=t.onNotesChange||(()=>{}),this.onSeek=t.onSeek||(()=>{}),this.isDraggingPlayhead=!1,this.init()}updateDimensions(){const t=getComputedStyle(document.documentElement);this.rowHeight=parseInt(t.getPropertyValue("--row-height"))||16,this.colWidth=parseInt(t.getPropertyValue("--col-width"))||20,this.keyWidth=parseInt(t.getPropertyValue("--key-width"))||48}init(){this.renderKeyboard(),this.setupCanvas(),this.renderGrid(),this.renderTimeline(),this.bindEvents(),this.bindTimelineEvents(),this.scrollToCenter()}getNoteNameFromMidi(t){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],i=Math.floor(t/12)-1,s=e[t%12];return{name:s,octave:i,full:`${s}${i}`}}isBlackKey(t){const e=t%12;return[1,3,6,8,10].includes(e)}renderKeyboard(){this.keyboard.innerHTML="";for(let t=this.highestNote;t>=this.lowestNote;t--){this.getNoteNameFromMidi(t);const e=this.isBlackKey(t),i=document.createElement("div");i.className=`piano-key ${e?"black-key":"white-key"}`,i.dataset.midi=t,this.keyboard.appendChild(i)}}setupCanvas(){this.resizeCanvas(),window.addEventListener("resize",()=>{this.updateDimensions(),this.resizeCanvas(),this.renderGrid(),this.renderTimeline(),this.renderNotes()})}resizeCanvas(){const t=Math.max(this.totalColumns*this.colWidth*this.zoom,this.gridWrapper.clientWidth),e=this.totalKeys*this.rowHeight;this.canvas.width=t,this.canvas.height=e,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${e}px`,this.notesContainer.style.width=`${t}px`,this.notesContainer.style.height=`${e}px`}renderGrid(){const t=this.canvas.width,e=this.canvas.height;this.ctx.clearRect(0,0,t,e);const i="rgba(178, 186, 170, 1)",s="rgba(168, 176, 162, 1)",o="rgba(148, 156, 142, 0.55)",n="rgba(128, 136, 122, 0.65)";for(let e=0;e<this.totalKeys;e++){const o=this.highestNote-e,n=this.isBlackKey(o),r=e*this.rowHeight;this.ctx.fillStyle=n?s:i,this.ctx.fillRect(0,r,t,this.rowHeight)}this.ctx.strokeStyle=o,this.ctx.lineWidth=1;for(let e=0;e<=this.totalKeys;e++){const i=e*this.rowHeight;this.ctx.beginPath(),this.ctx.moveTo(0,i+.5),this.ctx.lineTo(t,i+.5),this.ctx.stroke()}const r=this.colWidth*this.zoom,h=Math.ceil(t/r);for(let t=0;t<=h;t++){const i=t*r;t%4==0?(this.ctx.strokeStyle=n,this.ctx.lineWidth=1):(this.ctx.strokeStyle=o,this.ctx.lineWidth=.5),this.ctx.beginPath(),this.ctx.moveTo(i+.5,0),this.ctx.lineTo(i+.5,e),this.ctx.stroke()}}renderTimeline(){if(!this.timeline)return;const t=this.colWidth*this.zoom,e=this.totalColumns*t,i=16*t;let s=this.timeline.querySelector(".timeline-inner");s||((s=document.createElement("div")).className="timeline-inner",this.timeline.appendChild(s)),s.innerHTML="",s.style.width=`${e}px`;const o=Math.ceil(this.totalColumns/16);for(let t=0;t<=o;t++){const e=document.createElement("div");e.className="timeline-bar",e.style.left=`${t*i}px`,e.textContent=t+1,s.appendChild(e)}}bindTimelineEvents(){this.timeline&&(this.gridWrapper.addEventListener("scroll",()=>{this.timeline.scrollLeft=this.gridWrapper.scrollLeft}),this.timeline.addEventListener("click",t=>{if(this.isDraggingPlayhead)return;const e=this.timeline.getBoundingClientRect(),i=(t.clientX-e.left+this.timeline.scrollLeft)/(this.colWidth*this.zoom);this.onSeek(Math.max(0,i))}),this.playheadHandle&&(this.playheadHandle.addEventListener("mousedown",t=>{t.preventDefault(),t.stopPropagation(),this.isDraggingPlayhead=!0,this.playheadHandle.classList.add("dragging"),document.body.style.cursor="grabbing"}),document.addEventListener("mousemove",t=>{if(!this.isDraggingPlayhead)return;const e=this.gridWrapper.getBoundingClientRect(),i=(t.clientX-e.left+this.gridWrapper.scrollLeft)/(this.colWidth*this.zoom);this.onSeek(Math.max(0,i))}),document.addEventListener("mouseup",()=>{this.isDraggingPlayhead&&(this.isDraggingPlayhead=!1,this.playheadHandle.classList.remove("dragging"),document.body.style.cursor="")})))}setNotes(t){this.notes=t.map(t=>({...t})),this.isDirty=!1,this.updateTotalColumns(),this.resizeCanvas(),this.renderGrid(),this.renderTimeline(),this.renderNotes(),this.scrollToContent()}getNotes(){return this.notes.map(t=>({...t}))}updateTotalColumns(){if(0===this.notes.length)return void(this.totalColumns=100);const t=Math.max(...this.notes.map(t=>t.startTime+t.duration));this.totalColumns=Math.max(t+20,100)}renderNotes(){this.notesContainer.innerHTML="";const t=this.colWidth*this.zoom;this.notes.forEach(e=>{const i=document.createElement("div");i.className="note",i.dataset.id=e.id;const s=this.highestNote-e.pitch,o=e.startTime*t,n=s*this.rowHeight,r=e.duration*t;i.style.left=`${o}px`,i.style.top=`${n+1}px`,i.style.width=`${r-1}px`,i.style.height=`${this.rowHeight-2}px`;const h=document.createElement("div");h.className="note-resize-handle left",i.appendChild(h);const a=document.createElement("div");a.className="note-resize-handle right",i.appendChild(a),this.notesContainer.appendChild(i)})}scrollToCenter(){const t=(this.highestNote-this.basePitch-10)*this.rowHeight;this.gridWrapper.scrollTop=Math.max(0,t),this.keyboard.scrollTop=this.gridWrapper.scrollTop}scrollToContent(){if(0===this.notes.length)return void this.scrollToCenter();const t=this.notes.map(t=>t.pitch),e=Math.min(...t),i=Math.max(...t),s=Math.floor((e+i)/2),o=this.highestNote-s,n=this.gridWrapper.clientHeight,r=o*this.rowHeight-n/2;this.gridWrapper.scrollTop=Math.max(0,r),this.keyboard.scrollTop=this.gridWrapper.scrollTop,this.gridWrapper.scrollLeft=0}bindEvents(){this.gridWrapper.addEventListener("scroll",()=>{this.keyboard.scrollTop=this.gridWrapper.scrollTop}),this.keyboard.addEventListener("scroll",()=>{this.gridWrapper.scrollTop=this.keyboard.scrollTop}),this.keyboard.addEventListener("mousedown",t=>{const e=t.target.closest(".piano-key");if(e){const t=parseInt(e.dataset.midi);this.onNotePreview(t)}}),this.keyboard.addEventListener("touchstart",t=>{const e=t.target.closest(".piano-key");if(e){t.preventDefault();const i=parseInt(e.dataset.midi);this.onNotePreview(i)}},{passive:!1}),this.bindGridEvents()}bindGridEvents(){this.gridWrapper.addEventListener("mousedown",t=>this.handlePointerDown(t,"mouse")),this.gridWrapper.addEventListener("mousemove",t=>this.handlePointerMove(t,"mouse")),this.gridWrapper.addEventListener("mouseup",t=>this.handlePointerUp(t,"mouse")),this.gridWrapper.addEventListener("mouseleave",t=>this.handlePointerUp(t,"mouse")),this.gridWrapper.addEventListener("contextmenu",t=>{t.preventDefault();const e=t.target.closest(".note");e&&this.deleteNote(e.dataset.id)}),this.gridWrapper.addEventListener("touchstart",t=>this.handlePointerDown(t,"touch"),{passive:!1}),this.gridWrapper.addEventListener("touchmove",t=>this.handlePointerMove(t,"touch"),{passive:!1}),this.gridWrapper.addEventListener("touchend",t=>this.handlePointerUp(t,"touch")),this.gridWrapper.addEventListener("touchcancel",t=>this.handlePointerUp(t,"touch"))}getPointerPosition(t,e){const i=this.gridWrapper.getBoundingClientRect();let s,o;if("touch"===e)if(t.touches&&t.touches.length>0)s=t.touches[0].clientX,o=t.touches[0].clientY;else{if(!(t.changedTouches&&t.changedTouches.length>0))return null;s=t.changedTouches[0].clientX,o=t.changedTouches[0].clientY}else s=t.clientX,o=t.clientY;return{x:s-i.left+this.gridWrapper.scrollLeft,y:o-i.top+this.gridWrapper.scrollTop}}positionToGrid(t){const e=this.colWidth*this.zoom,i=Math.floor(t.x/e),s=Math.floor(t.y/this.rowHeight);return{col:i,row:s,pitch:this.highestNote-s}}handlePointerDown(t,e){const i=this.getPointerPosition(t,e);if(!i)return;const s=t.target.closest(".note"),o=t.target.classList.contains("note-resize-handle");if(s){const n=s.dataset.id,r=this.notes.find(t=>t.id===n);if(!r)return;if("touch"===e&&(t.preventDefault(),this.longPressTimer=setTimeout(()=>{this.deleteNote(n),this.dragState=null},this.longPressDelay)),o){const e=t.target.classList.contains("left");this.dragState={type:"resize",noteId:n,side:e?"left":"right",startPos:i,originalNote:{...r}}}else this.dragState={type:"move",noteId:n,startPos:i,originalNote:{...r}};s.classList.add("dragging")}else if(t.target===this.canvas||t.target===this.notesContainer){"touch"===e&&t.preventDefault();const s=this.positionToGrid(i);this.dragState={type:"create",startPos:i,startGrid:s}}}handlePointerMove(t,e){if(!this.dragState)return;const i=this.getPointerPosition(t,e);if(!i)return;if(this.longPressTimer){const t=Math.abs(i.x-this.dragState.startPos.x),e=Math.abs(i.y-this.dragState.startPos.y);(t>5||e>5)&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)}"touch"===e&&t.preventDefault();const s=this.colWidth*this.zoom;if("move"===this.dragState.type){const t=this.notes.find(t=>t.id===this.dragState.noteId);if(!t)return;const e=i.x-this.dragState.startPos.x,o=i.y-this.dragState.startPos.y,n=Math.round(e/s),r=Math.round(o/this.rowHeight);t.startTime=Math.max(0,this.dragState.originalNote.startTime+n),t.pitch=Math.min(this.highestNote,Math.max(this.lowestNote,this.dragState.originalNote.pitch-r)),this.renderNotes(),this.markDirty()}else if("resize"===this.dragState.type){const t=this.notes.find(t=>t.id===this.dragState.noteId);if(!t)return;const e=i.x-this.dragState.startPos.x,o=Math.round(e/s);if("right"===this.dragState.side)t.duration=Math.max(1,this.dragState.originalNote.duration+o);else{const e=this.dragState.originalNote.startTime+o,i=this.dragState.originalNote.duration-o;e>=0&&i>=1&&(t.startTime=e,t.duration=i)}this.renderNotes(),this.markDirty()}else this.dragState.type}handlePointerUp(t,e){if(this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),!this.dragState)return;const i=this.getPointerPosition(t,e);if(document.querySelectorAll(".note.dragging").forEach(t=>{t.classList.remove("dragging")}),"create"===this.dragState.type&&i){const t=this.positionToGrid(i),e=Math.min(this.dragState.startGrid.col,t.col),s=Math.max(this.dragState.startGrid.col,t.col)-e+1,o=s<=1?this.lastNoteDuration:s;this.addNote({pitch:this.dragState.startGrid.pitch,startTime:e,duration:o})}if("move"===this.dragState.type||"resize"===this.dragState.type){if("resize"===this.dragState.type){const t=this.notes.find(t=>t.id===this.dragState.noteId);t&&(this.lastNoteDuration=t.duration)}this.onNotesChange(this.notes)}this.dragState=null}addNote(t){if(t.pitch<this.lowestNote||t.pitch>this.highestNote)return;const e={id:`note-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,pitch:t.pitch,startTime:Math.max(0,t.startTime),duration:Math.max(1,t.duration)};this.notes.push(e),this.lastNoteDuration=e.duration,this.markDirty(),this.updateTotalColumns(),this.resizeCanvas(),this.renderGrid(),this.renderNotes(),this.onNotesChange(this.notes),this.onNotePreview(e.pitch)}deleteNote(t){const e=this.notes.findIndex(e=>e.id===t);if(-1!==e){const t=this.notes[e];this.lastNoteDuration=t.duration,this.notes.splice(e,1),this.markDirty(),this.renderNotes(),this.onNotesChange(this.notes)}}markDirty(){this.isDirty=!0}clearDirty(){this.isDirty=!1}setZoom(t){this.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,t)),this.resizeCanvas(),this.renderGrid(),this.renderTimeline(),this.renderNotes()}zoomIn(){this.setZoom(1.25*this.zoom)}zoomOut(){this.setZoom(this.zoom/1.25)}clear(){this.notes=[],this.isDirty=!1,this.totalColumns=100,this.resizeCanvas(),this.renderGrid(),this.renderNotes()}}