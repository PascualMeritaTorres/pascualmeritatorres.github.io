class ImageProcessor{constructor(){this.isReady=!1,this.cv=null,this.config={maxImageWidth:600,minContourAreaPercent:.015,minContourPoints:3,totalDuration:64,pitchRange:{min:48,max:96},epsilonFactor:.002,resampleInterval:4,minNotesPerContour:16,bilateralD:9,bilateralSigmaColor:75,bilateralSigmaSpace:75,claheClipLimit:2,claheTileSize:8,cannyLow:50,cannyHigh:100,morphKernelSize:3},this.scales={pentatonic:[0,2,4,7,9],major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11]}}async init(){if(!this.isReady)return new Promise((t,e)=>{if(window.cv&&window.cv.Mat)return this.cv=window.cv,this.isReady=!0,void t();const n=document.createElement("script");n.src="https://docs.opencv.org/4.x/opencv.js",n.async=!0,n.onload=(()=>{const e=()=>{window.cv&&window.cv.Mat?(this.cv=window.cv,this.isReady=!0,t()):setTimeout(e,50)};window.cv&&(window.cv.onRuntimeInitialized=(()=>{this.cv=window.cv,this.isReady=!0,t()})),e()}),n.onerror=(()=>{e(new Error("Failed to load OpenCV.js"))}),document.head.appendChild(n)})}async processImage(t){this.isReady||await this.init();const e=this.cv;let n=null,o=null,i=null,s=null,r=null,a=null,h=null,l=null,c=null;try{if((n=e.imread(t)).cols>this.config.maxImageWidth){const t=this.config.maxImageWidth/n.cols,o=new e.Size(this.config.maxImageWidth,Math.round(n.rows*t));e.resize(n,n,o,0,0,e.INTER_AREA)}const u=n.cols*n.rows;o=new e.Mat,e.cvtColor(n,o,e.COLOR_RGBA2GRAY),i=new e.Mat;const p=new e.CLAHE(this.config.claheClipLimit,new e.Size(this.config.claheTileSize,this.config.claheTileSize));p.apply(o,i),p["delete"](),s=new e.Mat,e.bilateralFilter(i,s,this.config.bilateralD,this.config.bilateralSigmaColor,this.config.bilateralSigmaSpace),r=new e.Mat,e.Canny(s,r,this.config.cannyLow,this.config.cannyHigh),a=new e.Mat,c=e.getStructuringElement(e.MORPH_ELLIPSE,new e.Size(this.config.morphKernelSize,this.config.morphKernelSize)),e.morphologyEx(r,a,e.MORPH_CLOSE,c),h=new e.MatVector,l=new e.Mat,e.findContours(a,h,l,e.RETR_EXTERNAL,e.CHAIN_APPROX_NONE);const g=this.filterContours(h,u),m=[];for(const t of g){const e=this.contourToNotes(t,n.cols,n.rows);m.push(...e)}for(const t of g)t["delete"]();return this.deduplicateNotes(m)}finally{if(n&&n["delete"](),o&&o["delete"](),i&&i["delete"](),s&&s["delete"](),r&&r["delete"](),a&&a["delete"](),c&&c["delete"](),l&&l["delete"](),h){for(let t=0;t<h.size();t++)h.get(t)["delete"]();h["delete"]()}}}filterContours(t,e){const n=this.cv,o=e*(this.config.minContourAreaPercent/100),i=[];for(let e=0;e<t.size();e++){const s=t.get(e),r=n.contourArea(s),a=s.rows;if(r>=o&&a>=this.config.minContourPoints){const t=s.clone();i.push(t)}}return i}contourToNotes(t,e,n){const o=this.cv,i=[],s=[];for(let e=0;e<t.rows;e++)s.push({x:t.data32S[2*e],y:t.data32S[2*e+1]});return s.length<2?i:(o.isContourConvex(t)||this.isClosedContour(s))&&s.length>=4?this.processClosedContour(s,e,n):this.processOpenContour(s,e,n)}isClosedContour(t){if(t.length<3)return!1;const e=t[0],n=t[t.length-1];return Math.sqrt(Math.pow(e.x-n.x,2)+Math.pow(e.y-n.y,2))<.05*Math.max(...t.map(t=>t.x),...t.map(t=>t.y))}processClosedContour(t,e,n){let o=0,i=0;for(let e=1;e<t.length;e++)t[e].x<t[o].x&&(o=e),t[e].x>t[i].x&&(i=e);const s=[],r=[],a=[...t.slice(o),...t.slice(0,o)];let h=0;for(let t=1;t<a.length;t++)a[t].x>a[h].x&&(h=t);for(let t=0;t<=h;t++)s.push(a[t]);for(let t=h;t<a.length;t++)r.push(a[t]);return r.push(a[0]),[...this.processOpenContour(s,e,n),...this.processOpenContour(r,e,n)]}resampleContour(t){if(t.length<2)return t;const e=[t[0]];let n=0;const o=this.config.resampleInterval;for(let i=1;i<t.length;i++){const s=t[i-1],r=t[i],a=Math.sqrt(Math.pow(r.x-s.x,2)+Math.pow(r.y-s.y,2));let h=a,l=o-n;for(;l<=h;){const t=l/a;e.push({x:s.x+t*(r.x-s.x),y:s.y+t*(r.y-s.y)}),h-=l,l=o}n=(n+a)%o}const i=t[t.length-1],s=e[e.length-1];return s.x===i.x&&s.y===i.y||e.push(i),e.length<this.config.minNotesPerContour&&t.length>=2?this.interpolateToMinPoints(t,this.config.minNotesPerContour):e}interpolateToMinPoints(t,e){if(t.length>=e)return t;const n=[],o=this.getContourLength(t)/(e-1);let i=0,s=0;n.push(t[0]);for(let r=1;r<e-1;r++){const e=r*o;for(;i+this.getSegmentLength(t,s)<e&&s<t.length-2;)i+=this.getSegmentLength(t,s),s++;const a=this.getSegmentLength(t,s),h=a>0?(e-i)/a:0,l=t[s],c=t[Math.min(s+1,t.length-1)];n.push({x:l.x+h*(c.x-l.x),y:l.y+h*(c.y-l.y)})}return n.push(t[t.length-1]),n}getContourLength(t){let e=0;for(let n=0;n<t.length-1;n++)e+=this.getSegmentLength(t,n);return e}getSegmentLength(t,e){if(e>=t.length-1)return 0;const n=t[e],o=t[e+1];return Math.sqrt(Math.pow(o.x-n.x,2)+Math.pow(o.y-n.y,2))}processOpenContour(t,e,n){const o=[],i=this.resampleContour(t);for(let t=0;t<i.length;t++){const s=i[t],r=this.calculateCurvature(i,t),a=this.classifySegment(r),h=this.yPositionToPitch(s.y,n),l=this.xPositionToTime(s.x,e),c=this.quantizeToScale(h,a.scale);let u=1;if("SUSTAINED"===a.type)u=Math.min(4,Math.max(1,Math.floor(a.duration/4)));else if("SLOW_SCALE"===a.type)u=4;else if("MEDIUM_SCALE"===a.type)u=2;else if("CHORD"===a.type){u=2;const t=this.generateChordTones(c,5);for(const e of t)e!==c&&o.push({id:`note-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,pitch:e,startTime:l,duration:u})}o.push({id:`note-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,pitch:c,startTime:l,duration:u})}return o}calculateCurvature(t,e){if(0===e||e>=t.length-1)return 0;const n=t[e-1],o=t[e],i=t[e+1],s=Math.abs((o.x-n.x)*(i.y-n.y)-(i.x-n.x)*(o.y-n.y))/2,r=Math.sqrt(Math.pow(o.x-n.x,2)+Math.pow(o.y-n.y,2)),a=Math.sqrt(Math.pow(i.x-o.x,2)+Math.pow(i.y-o.y,2)),h=Math.sqrt(Math.pow(i.x-n.x,2)+Math.pow(i.y-n.y,2));return r*a*h==0?0:4*s/(r*a*h)}classifySegment(t){return t<.01?{type:"SUSTAINED",duration:8,scale:"pentatonic"}:t<.05?{type:"SLOW_SCALE",scale:"pentatonic"}:t<.15?{type:"MEDIUM_SCALE",scale:"pentatonic"}:t<.4?{type:"FAST_SCALE",scale:"pentatonic"}:{type:"CHORD",scale:"pentatonic"}}yPositionToPitch(t,e){const n=1-t/e,{min:o,max:i}=this.config.pitchRange;return Math.round(o+n*(i-o))}xPositionToTime(t,e){return t/e*this.config.totalDuration}quantizeToScale(t,e){const n=this.scales[e]||this.scales.chromatic,o=60,i=Math.floor((t-o)/12);let s=((t-o)%12+12)%12,r=n[0],a=Math.abs(s-n[0]);for(const t of n){const e=Math.min(Math.abs(s-t),Math.abs(s-t+12),Math.abs(s-t-12));e<a&&(a=e,r=t)}return o+12*i+r}generateChordTones(t,e){const n=[t],o=[3,4,7,10,12];for(let i=0;i<Math.min(e-1,o.length);i++){const e=t+o[i];e>=21&&e<=108&&n.push(e)}return n}deduplicateNotes(t){if(0===t.length)return t;const e=[...t].sort((t,e)=>t.pitch!==e.pitch?t.pitch-e.pitch:t.startTime-e.startTime),n=[];let o=e[0];for(let t=1;t<e.length;t++){const i=e[t];if(i.pitch===o.pitch){const t=o.startTime+o.duration,e=i.startTime+i.duration;if(i.startTime<t){(t-i.startTime)/Math.min(o.duration,i.duration)>.5?o={...o,duration:Math.max(t,e)-o.startTime}:(n.push(o),o=i)}else n.push(o),o=i}else n.push(o),o=i}return n.push(o),n}}window.ImageProcessor=ImageProcessor;