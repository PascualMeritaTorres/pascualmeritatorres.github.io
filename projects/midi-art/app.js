class Text2MidiArt{constructor(){this.textInput=document.getElementById("text-input"),this.charCount=document.getElementById("char-count"),this.generateBtn=document.getElementById("generate-btn"),this.inputError=document.getElementById("input-error"),this.imageDropZone=document.getElementById("image-drop-zone"),this.imageInput=document.getElementById("image-input"),this.dropZoneContent=document.getElementById("drop-zone-content"),this.imagePreview=document.getElementById("image-preview"),this.previewImg=document.getElementById("preview-img"),this.imageClearBtn=document.getElementById("image-clear-btn"),this.playBtn=document.getElementById("play-btn"),this.playIcon=document.getElementById("play-icon"),this.pauseIcon=document.getElementById("pause-icon"),this.stopBtn=document.getElementById("stop-btn"),this.tempoValue=document.getElementById("tempo-value"),this.tempoUp=document.getElementById("tempo-up"),this.tempoDown=document.getElementById("tempo-down"),this.zoomInBtn=document.getElementById("zoom-in-btn"),this.zoomOutBtn=document.getElementById("zoom-out-btn"),this.exportBtn=document.getElementById("export-btn"),this.playhead=document.getElementById("playhead"),this.confirmDialog=document.getElementById("confirm-dialog"),this.confirmCancel=document.getElementById("confirm-cancel"),this.confirmOk=document.getElementById("confirm-ok"),this.clearNotesBtn=document.getElementById("clear-notes-btn"),this.noteCount=document.getElementById("note-count"),this.statusIndicator=document.getElementById("status-indicator"),this.currentText="",this.pendingText=null,this.pendingImage=null,this.currentImage=null,this.tempo=120,this.isProcessingImage=!1,this.pianoRoll=new PianoRoll({onNotePreview:e=>this.playback.previewNote(e),onNotesChange:e=>this.onNotesChange(e),onSeek:e=>this.handleSeek(e)}),this.activeNoteCounts={},this.currentPlayheadPosition=0,this.playback=new Playback({bpm:this.tempo,onPlayStateChange:e=>this.updatePlayButton(e),onPlayheadUpdate:e=>this.updatePlayhead(e),onNoteStart:e=>this.onPlaybackNoteStart(e),onNoteEnd:e=>this.onPlaybackNoteEnd(e)}),this.midiExport=new MidiExport,this.imageProcessor=new ImageProcessor,this.bindEvents(),this.bindImageEvents(),this.bindKeyboardPiano(),this.updateCharCount(),this.updateTempoDisplay(),this.loadDefaultImage()}bindKeyboardPiano(){this.keyToMidi={KeyA:60,KeyS:62,KeyD:64,KeyF:65,KeyG:67,KeyH:69,KeyJ:71,KeyK:72,KeyL:74,Semicolon:76,Quote:77,KeyW:61,KeyE:63,KeyT:66,KeyY:68,KeyU:70,KeyO:73,KeyP:75},this.activeKeys=new Set,document.addEventListener("keydown",e=>{if(document.activeElement===this.textInput)return;const t=this.keyToMidi[e.code];t===undefined||this.activeKeys.has(e.code)||(e.preventDefault(),this.activeKeys.add(e.code),this.playback.previewNote(t),this.highlightPianoKey(t,!0))}),document.addEventListener("keyup",e=>{const t=this.keyToMidi[e.code];t!==undefined&&(this.activeKeys["delete"](e.code),this.highlightPianoKey(t,!1))})}highlightPianoKey(e,t){const i=document.querySelector(`.piano-key[data-midi="${e}"]`);i&&i.classList.toggle("active",t)}onPlaybackNoteStart(e){this.activeNoteCounts[e]=(this.activeNoteCounts[e]||0)+1,this.highlightPianoKey(e,!0)}onPlaybackNoteEnd(e){this.activeNoteCounts[e]=(this.activeNoteCounts[e]||1)-1,this.activeNoteCounts[e]<=0&&(this.activeNoteCounts[e]=0,this.highlightPianoKey(e,!1))}clearAllPianoKeyHighlights(){document.querySelectorAll(".piano-key.active").forEach(e=>{e.classList.remove("active")}),this.activeNoteCounts={}}loadDefaultImage(){const e="/projects/midi-art/apple-logo.jpg",t=new Image;t.crossOrigin="anonymous",t.onload=(()=>{this.currentImage=t,this.showImagePreview(e)}),t.onerror=(()=>{console.warn("Default image not found:",e)}),t.src=e}bindImageEvents(){this.imageDropZone&&(this.imageDropZone.addEventListener("click",e=>{e.target===this.imageClearBtn||this.imageClearBtn&&this.imageClearBtn.contains(e.target)||this.imageInput.click()}),this.imageInput.addEventListener("change",e=>{const t=e.target.files[0];t&&this.handleImageFile(t)}),this.imageDropZone.addEventListener("dragover",e=>{e.preventDefault(),e.stopPropagation(),this.imageDropZone.classList.add("drag-over")}),this.imageDropZone.addEventListener("dragleave",e=>{e.preventDefault(),e.stopPropagation(),this.imageDropZone.classList.remove("drag-over")}),this.imageDropZone.addEventListener("drop",e=>{e.preventDefault(),e.stopPropagation(),this.imageDropZone.classList.remove("drag-over");const t=e.dataTransfer.files[0];t&&t.type.startsWith("image/")&&this.handleImageFile(t)}),this.imageClearBtn&&this.imageClearBtn.addEventListener("click",e=>{e.stopPropagation(),this.clearImage()}))}handleImageFile(e){if(!e.type.startsWith("image/"))return void this.showError("Please select an image file (JPG, PNG, GIF, WebP)");if(e.size>10485760)return void this.showError("Image too large. Maximum size is 10MB.");this.clearError();const t=new Image,i=new FileReader;i.onload=(e=>{t.onload=(()=>{this.currentImage=t,this.showImagePreview(e.target.result),this.textInput.value="",this.updateCharCount()}),t.src=e.target.result}),i.readAsDataURL(e)}showImagePreview(e){this.previewImg&&this.imagePreview&&this.dropZoneContent&&(this.previewImg.src=e,this.dropZoneContent.style.display="none",this.imagePreview.style.display="flex")}clearImage(){this.currentImage=null,this.pendingImage=null,this.imageInput&&(this.imageInput.value=""),this.previewImg&&(this.previewImg.src=""),this.dropZoneContent&&(this.dropZoneContent.style.display="flex"),this.imagePreview&&(this.imagePreview.style.display="none")}bindEvents(){this.textInput.addEventListener("input",()=>{this.updateCharCount(),this.clearError()}),this.textInput.addEventListener("keypress",e=>{"Enter"===e.key&&this.handleGenerate()}),this.generateBtn.addEventListener("click",()=>this.handleGenerate()),this.playBtn.addEventListener("click",()=>this.handlePlay()),this.stopBtn.addEventListener("click",()=>this.handleStop()),this.tempoUp.addEventListener("click",()=>this.changeTempo(1)),this.tempoDown.addEventListener("click",()=>this.changeTempo(-1)),this.zoomInBtn.addEventListener("click",()=>this.pianoRoll.zoomIn()),this.zoomOutBtn.addEventListener("click",()=>this.pianoRoll.zoomOut()),this.pianoRoll.gridWrapper.addEventListener("scroll",()=>{this.renderPlayhead()}),this.exportBtn.addEventListener("click",()=>this.handleExport()),this.confirmCancel.addEventListener("click",()=>this.hideConfirmDialog()),this.confirmOk.addEventListener("click",()=>this.confirmGenerate()),this.clearNotesBtn.addEventListener("click",()=>this.handleClearNotes()),this.confirmDialog.addEventListener("click",e=>{e.target===this.confirmDialog&&this.hideConfirmDialog()}),document.addEventListener("keydown",e=>{if(document.activeElement!==this.textInput){switch(e.code){case"Space":e.preventDefault(),this.handlePlay();break;case"Escape":this.handleStop();break;case"Enter":e.preventDefault(),this.handleGenerate();break;case"Equal":case"NumpadAdd":this.changeTempo(1);break;case"Minus":case"NumpadSubtract":this.changeTempo(-1)}(e.metaKey||e.ctrlKey)&&"e"===e.key&&(e.preventDefault(),this.handleExport())}else"Enter"===e.key&&(e.preventDefault(),this.handleGenerate())})}updateCharCount(){const e=this.textInput.value.length;this.charCount.textContent=e}showError(e){this.inputError.textContent=e}clearError(){this.inputError.textContent=""}updateTempoDisplay(){this.tempoValue.textContent=this.tempo}changeTempo(e){this.tempo=Math.max(40,Math.min(240,this.tempo+e)),this.updateTempoDisplay(),this.playback.setTempo(this.tempo)}handleGenerate(){if(this.currentImage)return void this.handleImageGenerate();const e=this.textInput.value,t=validateText(e);if(t.valid){if(this.clearError(),this.pianoRoll.isDirty&&this.pianoRoll.notes.length>0)return this.pendingText=e,void this.showConfirmDialog();this.generateNotes(e)}else this.showError(t.error)}async handleImageGenerate(){if(!this.isProcessingImage){if(this.clearError(),this.pianoRoll.isDirty&&this.pianoRoll.notes.length>0)return this.pendingImage=this.currentImage,void this.showConfirmDialog();await this.generateNotesFromImage(this.currentImage)}}async generateNotesFromImage(e){if(!this.isProcessingImage){this.isProcessingImage=!0,this.handleStop(),this.updateStatus("PROCESSING..."),this.generateBtn.disabled=!0;try{const i=await this.imageProcessor.processImage(e);if(0===i.length)return this.showError("No contours found in image. Try a higher contrast image."),void this.updateStatus("READY");this.pianoRoll.setNotes(i),this.playback.setNotes(i),this.currentText="image",this.updateNoteCount(i.length),this.updateStatus("READY")}catch(t){console.error("Image processing error:",t),this.showError("Failed to process image. Please try another image."),this.updateStatus("ERROR")}finally{this.isProcessingImage=!1,this.generateBtn.disabled=!1}}}showConfirmDialog(){this.confirmDialog.style.display="flex"}hideConfirmDialog(){this.confirmDialog.style.display="none",this.pendingText=null,this.pendingImage=null}confirmGenerate(){const e=this.pendingText,t=this.pendingImage;this.hideConfirmDialog(),null!==t?this.generateNotesFromImage(t):null!==e&&this.generateNotes(e)}generateNotes(e){this.handleStop();const t=textToNotes(e,60);this.pianoRoll.setNotes(t),this.playback.setNotes(t),this.currentText=e,this.updateNoteCount(t.length),this.updateStatus("READY")}onNotesChange(e){this.playback.setNotes(e),this.updateNoteCount(e.length)}updateNoteCount(e){this.noteCount&&(this.noteCount.textContent=e),this.clearNotesBtn&&(this.clearNotesBtn.style.display=e>0?"flex":"none")}handleClearNotes(){this.handleStop(),this.pianoRoll.setNotes([]),this.playback.setNotes([]),this.currentText="",this.updateNoteCount(0),this.updateStatus("READY")}updateStatus(e){this.statusIndicator&&(this.statusIndicator.textContent=e)}handlePlay(){this.playback.play()}handleStop(){this.playback.stop(),this.clearAllPianoKeyHighlights()}handleSeek(e){this.clearAllPianoKeyHighlights(),this.playback.seek(e),this.playhead.classList.add("visible")}updatePlayButton(e){this.playIcon.style.display=e?"none":"block",this.pauseIcon.style.display=e?"block":"none",this.playBtn.classList.toggle("active",e),e?(this.playhead.classList.add("visible"),this.updateStatus("PLAYING")):this.updateStatus("READY")}updatePlayhead(e){this.currentPlayheadPosition=e,this.renderPlayhead(),0!==e||this.playback.isPlaying||this.playhead.classList.remove("visible")}renderPlayhead(){const e=this.pianoRoll.colWidth*this.pianoRoll.zoom,t=this.pianoRoll.gridWrapper.scrollLeft,i=this.pianoRoll.keyWidth,n=this.currentPlayheadPosition*e-t+i;this.playhead.style.left=`${n}px`;const s=this.pianoRoll.gridWrapper.clientWidth,a=n>=i&&n<=i+s;this.playhead.style.opacity=a?"1":"0"}handleExport(){const e=this.pianoRoll.getNotes();if(0===e.length)return void this.showError("No notes to export. Generate some text first!");const t=this.midiExport.generateFilename(this.currentText);this.midiExport["export"](e,t,this.tempo)}}document.addEventListener("DOMContentLoaded",()=>{window.app=new Text2MidiArt});