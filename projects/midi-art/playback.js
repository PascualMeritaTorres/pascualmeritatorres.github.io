class Playback{constructor(t={}){this.bpm=t.bpm||120,this.notes=[],this.isPlaying=!1,this.synth=null,this.scheduledEvents=[],this.onPlayStateChange=t.onPlayStateChange||(()=>{}),this.onPlayheadUpdate=t.onPlayheadUpdate||(()=>{}),this.onLoopRestart=t.onLoopRestart||(()=>{}),this.onNoteStart=t.onNoteStart||(()=>{}),this.onNoteEnd=t.onNoteEnd||(()=>{}),this.animationFrame=null,this.loopEnd=0,this.init()}async init(){this.synth=new Tone.PolySynth(Tone.Synth,{maxPolyphony:128,oscillator:{type:"triangle"},envelope:{attack:.01,decay:.3,sustain:.4,release:.8}}).toDestination(),this.synth.volume.value=-6,Tone.Transport.bpm.value=this.bpm,Tone.Transport.loop=!0}setNotes(t){this.notes=t,this.updateLoopEnd()}updateLoopEnd(){if(0===this.notes.length)this.loopEnd=64;else{const t=Math.max(...this.notes.map(t=>t.startTime+t.duration));this.loopEnd=4*Math.ceil((t+2)/4)}const t=this.loopEnd/4;Tone.Transport.loopEnd=`0:${t}:0`}midiToNoteName(t){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=Math.floor(t/12)-1;return`${e[t%12]}${s}`}scheduleNotes(){this.clearScheduledEvents(),this.notes.forEach(t=>{const e=Tone.Time(`0:0:${t.startTime}`).toSeconds(),s=Tone.Time(`0:0:${t.duration}`).toSeconds(),n=this.midiToNoteName(t.pitch),o=Tone.Transport.schedule(e=>{this.synth.triggerAttackRelease(n,s,e),Tone.Draw.schedule(()=>{this.onNoteStart(t.pitch)},e)},e),a=Tone.Transport.schedule(e=>{Tone.Draw.schedule(()=>{this.onNoteEnd(t.pitch)},e)},e+s);this.scheduledEvents.push(o,a)})}clearScheduledEvents(){this.scheduledEvents.forEach(t=>{Tone.Transport.clear(t)}),this.scheduledEvents=[]}async play(){await Tone.start(),this.isPlaying?this.pause():(this.scheduleNotes(),this.updateLoopEnd(),Tone.Transport.start(),this.isPlaying=!0,this.onPlayStateChange(!0),this.startPlayheadAnimation())}pause(){Tone.Transport.pause(),this.isPlaying=!1,this.onPlayStateChange(!1),this.stopPlayheadAnimation()}stop(){Tone.Transport.stop(),Tone.Transport.position=0,this.clearScheduledEvents(),this.isPlaying=!1,this.onPlayStateChange(!1),this.stopPlayheadAnimation(),this.onPlayheadUpdate(0)}startPlayheadAnimation(){const t=()=>{if(!this.isPlaying)return;const e=Tone.Transport.position.split(":"),s=16*(parseInt(e[0])||0)+4*(parseInt(e[1])||0)+(parseFloat(e[2])||0);this.onPlayheadUpdate(s),this.animationFrame=requestAnimationFrame(t)};t()}stopPlayheadAnimation(){this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null)}async previewNote(t){await Tone.start();const e=this.midiToNoteName(t);this.synth.triggerAttackRelease(e,"8n")}setTempo(t){this.bpm=t,Tone.Transport.bpm.value=t}setLoop(t){Tone.Transport.loop=t}seek(t){const e=Tone.Time(`0:0:${t}`).toSeconds();Tone.Transport.seconds=e,this.onPlayheadUpdate(t),this.isPlaying&&this.scheduleNotes()}dispose(){this.stop(),this.synth&&this.synth.dispose()}}